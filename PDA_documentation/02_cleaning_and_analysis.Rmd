---
output:
  html_document:
    code_folding: hide
  html_notebook: default
  pdf_document: default
---

# Delayed departures at Newark airport

## 1 Project brief

This project looks at the factors affecting delays to departures at Newark airport.

The brief I was given was:

*You have been hired by Newark airport to investigate the effect of weather on aeroplane departure delays.*

*They believe poor weather conditions are causing too many delays and want to invest in improving facilities, so that aircraft can take off in more types of weather. However, they do not fully understand how serious weather related delays are, and are not sure what type of weather they should be most concerned about. As part of investigating the effect of weather you should investigate other factors to understand how important weather is in comparison to them*

*They also want to understand how they compare to other New York airports.*

## 2 Definitions

For the purposes of this report, I am defining a late flight as one where the actual departure time was at least 15 minutes later than scheduled, in line with nationally reported statistics in the US^1^ 

I am using data on departures in 2017 from the following airports:

| FAA Code 	| Name 	|
|-	|-	|
| EWR 	| Newark Liberty International Airport 	|
| JFK 	| John F Kennedy International Airport 	|
| LGA 	| La Guardia Airport 	|

Details on how I handled missing data (along with other data cleaning/joining tasks) can be found in **Appendix I - missing data**

```{r, warning = F, message = F}

library(tidyverse)
library(here)
library(modelr)
library(GGally)
library(broom)
library(janitor)
library(anyflights)



all_data_clean <-
read_csv(here("data_clean/all_data_clean.csv")) %>% 

mutate(sched_dep_month = as.factor(sched_dep_month)) %>%
mutate(sched_dep_weekday = as.factor(sched_dep_weekday)) %>%
mutate(sched_dep_hour = as.factor(sched_dep_hour)) %>%
mutate(sched_dep_hour_group = as.factor(sched_dep_hour_group)) %>%
mutate(dest = as.factor(dest)) %>% 
mutate(carrier = as.factor(carrier)) %>% 
mutate(tailnum = as.factor(tailnum)) %>% 
mutate(plane_type = as.factor(plane_type)) %>% 
mutate(plane_model = as.factor(plane_model)) %>% 
mutate(engine = as.factor(engine)) %>% 
mutate(engines = as.factor(engines)) %>% 
mutate(visib_group = as.factor(visib_group)) %>%
mutate(wind_speed_beaufort_name = as.factor(wind_speed_beaufort_name)) %>%
mutate(wind_gust_beaufort_name = as.factor(wind_gust_beaufort_name)) %>%
mutate(wind_dir_cardinal = as.factor(wind_dir_cardinal)) %>%
mutate(precip_day_total_inch_group = as.factor(precip_day_total_inch_group)) %>%
mutate(snow_depth_day_total_inch_group = as.factor(snow_depth_day_total_inch_group)) 

```

## 3 Overview - number and percentage of delayed flights

The charts below show a comparison of delayed flights at the three airports.

Note that Newark (EWR) has the highest overall number of flights, and that the percentage of delayed flights is relatively consistent across all three.

The percentage of delayed flights at all three of these airports is high when compared with other busy US airports.^2^


```{r, warning = F, message = F}

all_data_clean %>% 
  
    mutate(flight_delayed = 
           fct_relevel(flight_delayed, 
                       "Departure delayed",
                       "Departed on time")) %>% 
  
  group_by(origin, flight_delayed) %>% 
  summarise(count = n()) %>% 
  
  ggplot()+
  aes(x = flight_delayed, y = count, fill = flight_delayed) +
  
  geom_col() +
  
  geom_text(aes(x = flight_delayed,
                y = count,
                label = count,
                vjust = 2),check_overlap = TRUE, size = 2) +

  
  facet_grid(~origin) +
  
  scale_y_continuous(labels = scales::comma) +
  
    scale_fill_manual(
    values = c(
      "Departure delayed" = "#d7191c",
      "Departed on time" = "#1a9641"
    )
  ) +
  
  theme(legend.position = "") +
  theme(plot.subtitle = element_text(size = 8)) +
  theme(axis.text = element_text(size = 7)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(axis.title = element_text(size = 8)) +
  
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  
  labs(title = "Flights in 2017 - NYC airports",
       subtitle = "Number of flights which departed late/on time  \n",
       x = "",
       y = "Number of flights \n")
```





```{r, warning = F, message = F}
# Total flights by airport
total_flights_by_airport <- all_data_clean %>% 
  group_by(origin) %>% 
  summarise(total_flights = n())
  

  all_data_clean %>%
  group_by(origin, flight_delayed) %>% 
  summarise(count_delayed_on_time = n()) %>% 
  left_join(total_flights_by_airport, by = "origin") %>% 
  mutate(pct_delayed_on_time = round((count_delayed_on_time/total_flights),2)) %>%

  
  ggplot()+
  geom_col() +
  aes(x = origin, y = pct_delayed_on_time, fill = flight_delayed) +
    
   geom_text(aes(label = str_c((100*pct_delayed_on_time), "%", sep = ""),
                position = "stack",
                vjust = 5),size = 2) +

  
  scale_y_continuous(labels = scales::percent) +
    
  scale_fill_manual(
    values = c(
      "Departure delayed" = "#d7191c",
      "Departed on time" = "#1a9641"
    )
  ) +
  
  theme(legend.position = "bottom") +
  theme(plot.subtitle = element_text(size = 8)) +
  theme(axis.text = element_text(size = 7)) +
  theme(axis.title = element_text(size = 8)) +
  
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  
  labs(title = "Flights in 2017 - NYC airports",
       subtitle = "Percent of flights which departed late/on time  \n",
       x = "Origin",
       y = "% \n",
       fill = "")
```

## 4 Which factors have an impact on flight delays?

To look into this, I have used information supplied with the brief on departures, weather and aircraft type. I have also sourced additional weather data^3^ because temperature and precipitation fields were largely unpopulated in the supplied file.

Details on how I handled missing or incomplete data can be found in **Appendix I - missing data**

Once I had cleaned and joined the data *(see cleaning script saved in scripts/data_load_clean.R)*, I used logistic modeling to identify variables which had a significant affect on variation in flight delays.



### 4.1 Significance testing - all variables


I first created a model for Newark Airport using all the available variables.

This returned a *p value* for each variable, which is a statistical test of whether it is significant or not in the model - variables with a p value greater than 0.05 are not significant, and were rejected.

I also rejected carrier (airline), destination and aircraft type which only had a significant value for some categories within them. Hour, weekday and month of departure were also discarded, as they are likely to be proxies for other variables (number of scheduled departures per hour, weather conditions).

This left me with the following list of significant variables:

* number of departures in scheduled departure hour

* visibility (miles)

* wind speed (mph)

* wind direction cardinal (N, S, E, W)

* precipitation daily total (inches)

* snowfall daily total (inches)

* temperature daily maximum (Fahrenheit)

```{r}
# Data for model
model_dataset_ewr <- all_data_clean %>%
  filter(origin == "EWR") %>%   
  mutate(flight_delayed_numeric = as.factor(ifelse(flight_delayed == "Departure delayed", 1, 0))) %>% 
select(   # from FLIGHTS
         flight_delayed_numeric,
         sched_dep_month,
         sched_dep_weekday,
         sched_dep_hour,
         number_departures_in_sched_dep_hour,
         dest,
         carrier,
         plane_type,
         # from WEATHER, NOAA_WEATHER
         visib,
         wind_speed_mph,
         wind_dir_cardinal,
         precip_day_total_inch,
         snowfall_day_total_inch,
         temp_max_day_f,
         temp_min_day_f,
         # from AIRPORTS
         dest_lat,
         dest_long) 
```

```{r}
# Logistic model EWR
ewr_multi_logreg_model <- glm(flight_delayed_numeric ~ ., 
         data = model_dataset_ewr, family = binomial(link = 'logit'))

ewr_tidy_out <- clean_names(tidy(ewr_multi_logreg_model))
glance_out <- clean_names(glance(ewr_multi_logreg_model))

clean_names(tidy(ewr_multi_logreg_model)) %>% 
  select(term, p_value) %>% 
  filter(p_value < 0.05) %>% 
  arrange(desc(term))
```

### 4.2 Significance testing - all variables - all NYC airports

As a comparison, I ran the same model used for Newark for the other airports as well, rejecting variables which were not significant as described in section 4.1 above. 

I do not think these figures should be used for any decision making purposes, but they are summarised below for information.

**p values for significant variables - all NYC airports**

<img src = "images/significant_p_all_airports.png">


```{r}
# Data for model - JFK
model_dataset_jfk <- all_data_clean %>%
  filter(origin == "JFK") %>%   
  mutate(flight_delayed_numeric = as.factor(ifelse(flight_delayed == "Departure delayed", 1, 0))) %>% 
select(   # from FLIGHTS
         flight_delayed_numeric,
         sched_dep_month,
         sched_dep_weekday,
         sched_dep_hour,
         number_departures_in_sched_dep_hour,
         dest,
         carrier,
         plane_type,
         # from WEATHER, NOAA_WEATHER
         visib,
         wind_speed_mph,
         wind_dir_cardinal,
         precip_day_total_inch,
         snowfall_day_total_inch,
         temp_max_day_f,
         temp_min_day_f,
         # from AIRPORTS
         dest_lat,
         dest_long) 

#Logistic model - JFK
jfk_multi_logreg_model <- glm(flight_delayed_numeric ~ ., 
         data = model_dataset_jfk, family = binomial(link = 'logit'))

jfk_tidy_out <- clean_names(tidy(jfk_multi_logreg_model))
jfk_glance_out <- clean_names(glance(jfk_multi_logreg_model))

jfk_significant_p_values <-  clean_names(tidy(jfk_multi_logreg_model)) %>%
  mutate(origin  = "JFK") %>% 
  select(origin, term, p_value) %>% 
  filter(p_value < 0.05) %>% 
  arrange(desc(term))

```

```{r}
# Data for model - LGA
model_dataset_lga <- all_data_clean %>%
  filter(origin == "LGA") %>%   
  mutate(flight_delayed_numeric = as.factor(ifelse(flight_delayed == "Departure delayed", 1, 0))) %>% 
select(   # from FLIGHTS
         flight_delayed_numeric,
         sched_dep_month,
         sched_dep_weekday,
         sched_dep_hour,
         number_departures_in_sched_dep_hour,
         dest,
         carrier,
         plane_type,
         # from WEATHER, NOAA_WEATHER
         visib,
         wind_speed_mph,
         wind_dir_cardinal,
         precip_day_total_inch,
         snowfall_day_total_inch,
         temp_max_day_f,
         temp_min_day_f,
         # from AIRPORTS
         dest_lat,
         dest_long) 

#Logistic model - LGA
lga_multi_logreg_model <- glm(flight_delayed_numeric ~ ., 
         data = model_dataset_lga, family = binomial(link = 'logit'))

lga_tidy_out <- clean_names(tidy(lga_multi_logreg_model))
lga_glance_out <- clean_names(glance(lga_multi_logreg_model))

lga_significant_p_values <-  clean_names(tidy(lga_multi_logreg_model)) %>%
  mutate(origin  = "LGA") %>% 
  select(origin, term, p_value) %>%  
  filter(p_value < 0.05) %>% 
  arrange(desc(term))
```

```{r}
# Combine significant p_values for all three airports into one table

ewr_significant_p_values <-  clean_names(tidy(ewr_multi_logreg_model)) %>%
  mutate(origin  = "EWR") %>%
  select(origin, term, p_value) %>% 
  filter(p_value < 0.05) %>% 
  arrange(desc(term)) 

all_airports_significant_p_values <- 
  bind_rows(ewr_significant_p_values,
            jfk_significant_p_values,
            lga_significant_p_values) %>% 
  pivot_wider(names_from = "origin", values_from = "p_value")


```


### 4.3 Logistic models - with and without non-weather variable

The brief asked me to look at both weather and non-weather variables; however, only one non-weather variable (number of departures in scheduled departure hour) was found to be significant - I'll return to this later in the **Factors not covered by the model** section.

I re-ran my logistic model for Newark (using the significant variables identified above) with and without *number of departures in scheduled departure hour*, to test which was a better model - this is measured using the AIC score: the lower the score, the better the model.

The AIC for the model WITHOUT the non-weather variable came back as being the slightly better model, with an AIC score of 124,219 compared to 124,221 for the model which INCLUDED the non-weather variable.


```{r}
# Data for model - significant variables only
model_dataset_significant_ewr <- all_data_clean %>%
  filter(origin == "EWR") %>%   
  mutate(flight_delayed_numeric = as.factor(ifelse(flight_delayed == "Departure delayed", 1, 0))) %>% 
select(   # from FLIGHTS
         flight_delayed_numeric,
         number_departures_in_sched_dep_hour,
         # from WEATHER, NOAA_WEATHER
         visib,
         wind_speed_mph,
         wind_dir_cardinal,
         precip_day_total_inch,
         snowfall_day_total_inch,
         temp_max_day_f) 
```


**AIC score for model WITH number of departures in scheduled departure hour**
```{r}
# Model WITH number of departures in scheduled departure hour
ewr_weather_and_nonweather_logreg_model <- glm(flight_delayed_numeric ~ ., 
         data = model_dataset_significant_ewr, family = binomial(link = 'logit'))

ewr_tidy_weather_non_weather_out <- clean_names(tidy(ewr_weather_and_nonweather_logreg_model))
glance_weather_non_weather_out <- clean_names(glance(ewr_weather_and_nonweather_logreg_model))

glance_weather_non_weather_out

```
```{r}
# Data for model - significant variables only WITHOUT no. departs in sched dep hour
model_dataset_significant_weather_ewr <- model_dataset_significant_ewr %>% 
select(-number_departures_in_sched_dep_hour) 
```

**AIC score for model WITHOUT number of departures in scheduled departure hour**
```{r}
# Model WITHOUT number of departures in scheduled departure hour
ewr_weather_logreg_model <- glm(flight_delayed_numeric ~ ., 
         data = model_dataset_significant_weather_ewr, family = binomial(link = 'logit'))

ewr_tidy_weather_out <- clean_names(tidy(ewr_weather_logreg_model))
glance_weather_out <- clean_names(glance(ewr_weather_logreg_model))

glance_weather_out
```

## 5 Factors not covered by the model

From the modeling above, it can be seen that when we look at the **available** variables in the data, weather factors are more important than non-weather factors when explaining variance in departure delays.

However, before drawing any conclusions from this, it is important to consider which factors are **not available** in the data.



The US Bureau of Transportation Statistics (BTS) has been collating figures on the causes of delays and cancellations since 2003^4^. 

Looking at their figures for late **arrivals and departures** at Newark in 2017^5^, you can see that there are some important factors which cannot be derived from the dataset used for my report.





<img src = "images/ewr_delays_2017_bts.png">

*Source: https://www.transtats.bts.gov/OT_Delay/OT_DelayCause1.asp?20=E*


I'm ignoring **national aviation system delay** for the moment - this is a complex, compound grouping which includes delays resulting from non-severe weather events as well as other causes.

However, **aircraft arriving late** is a potentially important factor in departure delays - for example, if the aircraft is late arriving from a previous flight, then its next departure is also likely to be delayed.

The `flights` dataset I'm using for this project only contains flights departing from the three NYC airports in 2017 - there is no information on previous flights for the aircraft involved.

It should be possible to source the extra information needed to analyse the effect of late arrivals - there are many public domain sources of flight data - but I have decided not to at this stage; given the amount of data involved (sourcing previous flight information for around 300,000 departures),  I don't feel it would be practical within the limited timeframe available to complete this project.

##  6 Conclusions

From the data available, it can be seen that a number of weather variables have a statistically important effect on variation within departure delays, whilst the *number departures in hour of scheduled departure* was the only significant non-weather variable.

Some of these may indeed be important in a real-world context - severe weather conditions will obviously have an impact, and the number of departures per hour may give useful indications on when the airport is reaching or exceeding capacity.


However, there are a number of factors which may be even more significant (such as the effect the delayed arrival of an earlier flight by the departing aircraft) which cannot be investigated with the data used to produce this report.

For this reason, I would strongly suggest a more in-depth analysis of a broader dataset before making any decisions on future investments; in particular, it may be useful to leverage the longstanding reporting on delay causes collated by the [Bureau of Transportation Statistics](https://www.transtats.bts.gov/OT_Delay/OT_DelayCause1.asp).




















### References

1 -   Definition of a delayed flight from the US Bureau of Transportation Statistics (BTS) https://www.bts.dot.gov/explore-topics-and-geography/topics/airline-time-performance-and-causes-flight-delays#q8

2 -   www.nj.com report on NYC flight delays in 2017 https://www.nj.com/news/2017/02/leaving_from_newark-liberty_chances_are_the_flight.html

3 -   Daily precipitation and temperature figures for the three airports sourced from the US National Oceanic and Atmospheric Administration (NOAA) https://www.ncdc.noaa.gov/cdo-web/search

4 -   BTS: Understanding the Reporting of Causes of Flight Delays and Cancellations https://www.bts.gov/topics/airlines-and-airports/understanding-reporting-causes-flight-delays-and-cancellations

5 -   BTS: Airline On-Time Statistics and Delay Causes https://www.transtats.bts.gov/OT_Delay/OT_DelayCause1.asp?20=E







### Appendix I -  missing data

This is a summary of missing of incomplete data items, and how I handled them in my analysis.

The code behind this is saved in the file *scripts/data_load_clean.R*, which was used to create a new table called `all_data_clean`

A copy of this code is shown in the code chunk below:
```{r}
library(tidyverse)
library(janitor)
library(here)
library(readxl)
library(lubridate)



# Load raw data
flights <- read_csv(here("data_raw/flights.csv")) %>% 
  clean_names()

weather <- read_csv(here("data_raw/weather.csv")) %>% 
  clean_names()

planes <- read_csv(here("data_raw/planes.csv")) %>% 
  clean_names()

airports <- read_csv(here("data_raw/airports.csv")) %>% 
  clean_names()

airlines <- read_csv(here("data_raw/airlines.csv")) %>% 
  clean_names()

data_dictionary <- read_excel(here("documentation/data_dictionary.xlsx"))

beaufort <- read_excel(here("data_raw/beaufort_scale_mph.xlsx"))


########################################################################

# CHANGES TO AIRPORTS TABLE

# Manually add missing airports 
# Using information from Wikipedia
missing_airports <- tibble(
faa = c("BQN", "PSE", "SJU", "STT"),
name = c("Rafael Hernandez Airport", "Mercedita International Airport", "Luis Munoz Marin International Airport", "Cyril E. King Airport"),
lat = c(18.495, 18.008333, 18.439167, 18.337222),
lon = c(-67.129444, -66.563056, -66.001944, -64.973333)
)

# Add these to main airports table
airports <- 
bind_rows(airports, missing_airports)

# Drop missing_airports tibble
rm(missing_airports)



########################################################################
########################################################################

# IMPORT AND JOIN THE THREE DAILY SUMMARY NOAA WEATHER TABLES

# Downloaded from https://www.ncdc.noaa.gov/cdo-web/search

# Data dictionary saved in documentation folder

# These are used for precipitation and temperature, which are mostly 
# 'na' in the weather file which came with the brief

#EWR
noaa_weather_ewr <- read_csv(here("data_raw/noaa_weather_2017_ewr.csv")) %>% clean_names()
# add column with airport code, select only columns to be used
noaa_weather_ewr <- noaa_weather_ewr %>% 
  mutate(origin = "EWR") %>% 
  select(origin,
         date,
         station,
         name,
         awnd,
         prcp,
         snow,
         snwd,
         tavg,
         tmax,
         tmin
  )

#LGA
noaa_weather_lga <- read_csv(here("data_raw/noaa_weather_2017_lga.csv")) %>% clean_names()
# add column with airport code, select only columns to be used
noaa_weather_lga <- noaa_weather_lga %>% 
  mutate(origin = "LGA")%>% 
  select(origin,
         date,
         station,
         name,
         awnd,
         prcp,
         snow,
         snwd,
         tavg,
         tmax,
         tmin
  )

#JFK
noaa_weather_jfk <- read_csv(here("data_raw/noaa_weather_2017_jfk.csv")) %>% clean_names()
# add column with airport code, select only columns to be used
noaa_weather_jfk <- noaa_weather_jfk %>% 
  mutate(origin = "JFK")%>% 
  select(origin,
         date,
         station,
         name,
         awnd,
         prcp,
         snow,
         snwd,
         tavg,
         tmax,
         tmin
  )

# Combine these into a single table, drop the individual ones
noaa_weather <- 
  bind_rows(noaa_weather_ewr, noaa_weather_lga, noaa_weather_jfk)

rm(noaa_weather_ewr, noaa_weather_lga, noaa_weather_jfk)


########################################################################
########################################################################

# MAKE CHANGES TO THE FLIGHTS TABLE

# add column to say if departure was delayed by 15 mins or more

# departure 15+ minutes late will be used as the definition of a delayed flight
#https://www.bts.dot.gov/explore-topics-and-geography/topics/airline-time-performance-and-causes-flight-delays#q8
flights <- flights %>%   
  mutate(flight_delayed =  case_when(
    is.na(dep_delay) ~ NA_character_,
    dep_delay >= 15 ~ "Departure delayed",
    dep_delay < 15 ~ "Departed on time",
    TRUE ~ "Error - please check"
  )
  ) 

# add column for delay time group
flights <- flights %>% 
  mutate(delay_group = case_when(
    is.na(dep_delay) ~ NA_character_,
    dep_delay >= 120 ~ "2h +",
    dep_delay >= 90 ~ "1.5h to <2h",
    dep_delay >= 60 ~ "1h to <1.5h",
    dep_delay >= 30 ~ "0.5h to <1h",
    dep_delay >= 15 ~ "0.25h to <0.5h",
    dep_delay < 15 ~ "<0.25h",
    TRUE ~ "Error - please check"
  )
  ) 


# add date in ymd format 
flights <- flights %>% 
  mutate(date_ymd = as_date(time_hour)) 

# get number of departures in hour
departures_per_hour <- flights %>% 
  group_by(origin, time_hour) %>% 
  summarise(number_departures_in_sched_dep_hour = n())
# add number_departures_in_sched_dep_hour to flights table
flights <- flights %>% 
  left_join(departures_per_hour, by = c("origin" = "origin",
                                        "time_hour" = "time_hour"))
# drop departures_per_hour table
rm(departures_per_hour)

 
  # add sched dep weekday column  (1 = Monday)
flights <- flights %>% 
  mutate(sched_dep_weekday = as.factor(wday(time_hour, week_start = 1))) 
  
  # add sched dep month column
flights <- flights %>% 
  mutate(sched_dep_month = as.factor(month(time_hour))) 
  
  # add sched dep hour column
flights <- flights %>% 
  mutate(sched_dep_hour = as.factor(hour(time_hour))) 
  
  # add sched dep hour_group column
flights <- flights %>% 
  mutate(sched_dep_hour_group = case_when(
    sched_dep_hour >= 18 ~ "18:00 to 23:59",
    sched_dep_hour >= 12 ~ "12:00 to 17:59",
    sched_dep_hour >= 6 ~ "06:00 to 11:59",
    sched_dep_hour >= 0 ~ "00:00 to 05:59"
   )
  )  

# convert fields to factors ?is  this necessary
flights <- flights %>% 
mutate(sched_dep_hour_group = as.factor(sched_dep_hour_group))

flights <- flights %>% 
  mutate(dest = as.factor(dest))

flights <- flights %>% 
  mutate(carrier = as.factor(carrier))

flights <- flights %>% 
  mutate(dest = as.factor(dest))
  
#################################################################### 
################### DROP RECORDS FROM FLIGHTS ######################
####################################################################
  
# drop records where actual departure time is null
flights <- flights %>% 
  filter(!is.na(dep_time)) 
  
  # drop records where  departure delay is null
flights <- flights %>% 
  filter(!is.na(dep_delay))


##################################################################
##################################################################


# MAKE CHANGES TO THE WEATHER TABLE

# This is the file which came with the brief


# Impute missing wind direction
# Replace na with median wind direction for the day

# Add date_ymd so wind direction can be grouped by day
weather <- weather %>% 
  mutate(date_ymd = as_date(time_hour))

# create table of daily median wind_dir
median_wind_dir <- weather %>% 
  filter(!is.na(wind_dir)) %>% 
  group_by(origin, date_ymd) %>% 
  summarise(median_wind_dir = median(wind_dir)) %>% 
  arrange(date_ymd)

# update weather table - replace na with median for day
weather <- weather %>% 
  left_join(median_wind_dir, by = c("date_ymd" = "date_ymd",
                                    "origin" = "origin")) %>% 
  mutate(wind_dir = ifelse(is.na(wind_dir),
                                 median_wind_dir,
                                 wind_dir)) %>% 
  select(-median_wind_dir)

# drop median wind dir table
rm(median_wind_dir)



# Impute missing wind speed

# 2647	records (around 10%) are missing wind speed, and I'd like to use this in my analysis
# I'm  updating these hourly readings with the daily average wind speed from the noaa_weather table

weather <- weather %>% 
 mutate(date_ymd = as_date(time_hour))


weather <- weather %>%
  left_join(noaa_weather, by = c("origin" = "origin",
                                 "date_ymd" = "date")) %>% 
  mutate(wind_speed = ifelse(is.na(wind_speed),
                                       awnd,
                                       wind_speed)
  ) %>% 
  select(-c("station", "name",  "awnd", "prcp", "snow", "snwd", "tavg", "tmax", "tmin"))

# create visibility groups
weather <- weather %>% 
  mutate(visib_group = case_when(
                        is.na(visib) ~ NA_character_,
                        visib >=8 ~ "8 to 10 miles",
                        visib >=6 ~ "6 to <8 miles",
                        visib >=4 ~ "4 to <6 miles",
                        visib >=2 ~ "2 to <4 miles",
                        visib >=0 ~ "0 to <2 miles",
                        TRUE ~ "Error - please check"
          )
  )


# rename wind_speed as wind_speed_mph
weather <- weather %>% 
  rename("wind_speed_mph" = "wind_speed")

# create wind_speed_kmh
weather <- weather %>% 
  mutate(wind_speed_kmh = 1.609344 * wind_speed_mph)

# rename wind_gust as wind_gust_mph
weather <- weather %>% 
  rename("wind_gust_mph" = "wind_gust")

# create wind_speed_kmh
weather <- weather %>% 
  mutate(wind_gust_kmh = 1.609344 * wind_gust_mph)


# add cardinal wind directions
weather <- weather %>% 
  mutate(wind_dir_cardinal = case_when(
    is.na(wind_dir) ~NA_character_,
    wind_speed_mph == 0 ~ "No wind",
    wind_dir >= 315 ~ "N",
    wind_dir >= 225 ~ "W",
    wind_dir >=  135 ~ "S",
    wind_dir >=  45 ~ "E",
    wind_dir > 0 ~ "N",
    #set as NA where wind_dir degree is 0 - these all have zero wind speed in data
    wind_dir == 0 ~ NA_character_,
    TRUE ~ "Error"
  )
  )

# following section uses info on the Beaufort scale sourced here:
# https://www.weather.gov/jetstream/beaufort_max

# add Beaufort numeric using wind SPEED
weather <- weather %>% 
  mutate(wind_speed_beaufort_numeric = case_when(
    is.na(wind_speed_mph) ~ NA_real_,
    wind_speed_mph >= 72 ~ 12,
    wind_speed_mph >= 64 ~ 11,
    wind_speed_mph >= 55 ~ 10,
    wind_speed_mph >= 47 ~ 9,
    wind_speed_mph >= 39 ~ 8,
    wind_speed_mph >= 32 ~ 7,
    wind_speed_mph >= 25 ~ 6,
    wind_speed_mph >= 19 ~ 5,
    wind_speed_mph >= 13 ~ 4,
    wind_speed_mph >= 8 ~ 3,
    wind_speed_mph >= 4 ~ 2,
    wind_speed_mph >= 1 ~ 1,
    TRUE ~ 0
    
  )
  ) 


# add beaufort numeric using wind GUST
weather <- weather %>% 
  mutate(wind_gust_beaufort_numeric = case_when(
    is.na(wind_gust_mph) ~ NA_real_,
    wind_gust_mph >= 72 ~ 12,
    wind_gust_mph >= 64 ~ 11,
    wind_gust_mph >= 55 ~ 10,
    wind_gust_mph >= 47 ~ 9,
    wind_gust_mph >= 39 ~ 8,
    wind_gust_mph >= 32 ~ 7,
    wind_gust_mph >= 25 ~ 6,
    wind_gust_mph >= 19 ~ 5,
    wind_gust_mph >= 13 ~ 4,
    wind_gust_mph >= 8 ~ 3,
    wind_gust_mph >= 4 ~ 2,
    wind_gust_mph >= 1 ~ 1,
    TRUE ~ 0
    
  )
  ) 
# look up beaufort name - speed 

# this uses the talble beaufort which I created with information from:
# https://www.weather.gov/jetstream/beaufort_max


weather  <- weather %>% 
  left_join(beaufort, by = c("wind_speed_beaufort_numeric"  = "beaufort_numeric")) %>% 
  select(-c(min_mph, max_mph, source)) %>% 
  rename("wind_speed_beaufort_name" = "beaufort_name")

# add beaufort number before beaufort name so data can be sorted more easily
weather  <- weather %>% 
  mutate(wind_speed_beaufort_name = str_c(wind_speed_beaufort_numeric,
                                          wind_speed_beaufort_name,
                                          sep = " - "))

# look up beaufort name - gust 
weather  <- weather %>% 
  left_join(beaufort, by = c("wind_gust_beaufort_numeric"  = "beaufort_numeric")) %>% 
  select(-c(min_mph, max_mph, source)) %>% 
  rename("wind_gust_beaufort_name" = "beaufort_name")


# add beaufort number before beaufort name so data can be sorted more easily
weather  <- weather %>% 
  mutate(wind_gust_beaufort_name = str_c(wind_gust_beaufort_numeric,
                                          wind_gust_beaufort_name,
                                          sep = " - "))

# convert fields to factors ?is  this necessary
weather <- weather %>% 
  mutate(wind_dir_cardinal = as.factor(wind_dir_cardinal))



# drop precipitation and temperature columns - I'm using noaa_weather table for this
weather <- weather %>% 
  select(-c(precip, temp))



# The section below created derived fields from the precip and temp columns
#  in the weather table

# THIS HAS BEEN HASHED OUT because I'm using noaa_weather for these fields instead

# I'm leaving the code in in case it's needed in future

# rename precip to precip_inch
# weather <- weather %>% 
#  rename("precip_inch" = "precip")

# create precip_cm column
#weather <- weather %>% 
#  mutate(precip_cm = 2.54 * precip_inch)

# add rainfall groups
#weather <- weather %>% 
#  mutate(precip_group = case_when(
#    is.na(precip_inch) ~ NA_character_,
#    precip_inch >= 2 ~ "2 inch +",
#    precip_inch >= 1.5 ~ "1.5 to <2 inch",
#    precip_inch >= 1 ~ "1 to <1.5 inch",
#    precip_inch >= 0.5 ~ "0.5 to <1 inch",
#    precip_inch > 0 ~ ">0 to <0.5 inch",
#    precip_inch == 0 ~ "0  inch",
#    TRUE ~ "Error - please check"
#  )
#  ) 




# rename temp to temp_f
#weather <- weather %>% 
#  rename("temp_f" = "temp")

# add temp Fahrenheit groups
# these groups match the Celsius groups below
#weather <- weather %>% 
#  mutate(temp_f_group = case_when(
#    is.na(temp_f) ~ NA_character_,
#    temp_f >= 104 ~ "104F+",
#    temp_f >= 86 ~ "86F to <104F",
#    temp_f >= 68 ~ "68F to <86F",
#    temp_f >= 50 ~ "50F to <68F",
#    temp_f >= 32 ~ "32F to <50F",
#    temp_f >= 14 ~ "14F to <32F",
#    temp_f >= -4 ~ "-4F to < 14F",
#    TRUE ~ "< -4F"
#  )
#  )

# add temp_c column
#weather <- weather %>% 
#  mutate(temp_c = (as.numeric(temp_f) - 32)*(5/9))

# add temp celsius groups
#weather <- weather %>% 
#  mutate(temp_c_group = case_when(
#    is.na(temp_c) ~ NA_character_,
#    temp_c >= 40 ~ "40c+",
#    temp_c >= 30 ~ "30c to <40c",
#    temp_c >= 20 ~ "20c to <30c",
#    temp_c >= 10 ~ "10c to <20c",
#    temp_c >= 0 ~ "0c to <10c",
#    temp_c >= -10 ~ "-10c to <0c",
#    temp_c >= -20 ~ "-20c to < -10c",
#    TRUE ~ "< -20c"
#  )
#  )





########################################################################
########################################################################

# CHANGES TO NOAA_WEATHER TABLE

# sourced from https://www.ncdc.noaa.gov/cdo-web/search
# Data dictionary saved in documentation folder


# rename precipitation column
noaa_weather <- noaa_weather %>% 
  rename("precip_day_total_inch" = "prcp")

# add metric precip column
noaa_weather <- noaa_weather %>% 
  mutate(precip_day_total_cm = 2.54 * precip_day_total_inch)

# add precipitation groups
noaa_weather <- noaa_weather %>% 
  mutate(precip_day_total_inch_group = case_when(
    is.na(precip_day_total_inch) ~ NA_character_,
    precip_day_total_inch >= 2 ~ "2 inch +",
    precip_day_total_inch >= 1.5 ~ "1.5 to <2 inch",
    precip_day_total_inch >= 1 ~ "1 to <1.5 inch",
    precip_day_total_inch >= 0.5 ~ "0.5 to <1 inch",
    precip_day_total_inch > 0 ~ ">0 to <0.5 inch",
    precip_day_total_inch == 0 ~ "0  inch",
    TRUE ~ "Error - please check"
    
  )
  )

# reorder based on these new groupings
noaa_weather <- noaa_weather %>% 

  mutate(precip_day_total_inch_group = factor
         (precip_day_total_inch_group, levels =
                                          c( "0  inch",
                                             ">0 to <0.5 inch",
                                             "0.5 to <1 inch", 
                                             "1 to <1.5 inch",
                                             "1.5 to <2 inch",
                                             "2 inch +")
         )
  )




# rename snowfall column
noaa_weather <- noaa_weather %>% 
  rename("snowfall_day_total_inch" = "snow")

# add metric snowfall column
noaa_weather <- noaa_weather %>% 
  mutate(snowfall_day_total_cm = 2.54 * snowfall_day_total_inch)

# add snowfall groups
noaa_weather <- noaa_weather %>% 
  mutate(snowfall_day_total_inch_group = case_when(
    is.na(snowfall_day_total_inch) ~ NA_character_,
    snowfall_day_total_inch >= 5 ~ "5 inch +",
    snowfall_day_total_inch >= 4 ~ "4 to <5 inch",
    snowfall_day_total_inch >= 3 ~ "3 to <4 inch",
    snowfall_day_total_inch >= 2 ~ "2 to <3 inch",
    snowfall_day_total_inch >= 1 ~ "1 to <2 inch",
    snowfall_day_total_inch > 0 ~ ">0 to <1 inch",
    snowfall_day_total_inch == 0 ~ "0  inch",
    TRUE ~ "Error - please check"
    )
  )

# reorder based on these new groupings
noaa_weather <- noaa_weather %>% 
  mutate(snowfall_day_total_inch_group = factor
         (snowfall_day_total_inch_group, levels =
                                                    c("0  inch",
                                                    ">0 to <1 inch",
                                                    "1 to <2 inch", 
                                                    "2 to <3 inch",
                                                    "3 to <4 inch",
                                                    "4 to <5 inch",
                                                    "5 inch +"))) 

# rename snow depth column
noaa_weather <- noaa_weather %>% 
  rename("snow_depth_day_total_inch" = "snwd")

# add metric snow depth column
noaa_weather <- noaa_weather %>% 
  mutate(snow_depth_day_total_cm = 2.54 * snow_depth_day_total_inch)

# add snow depth groups
  noaa_weather <- noaa_weather %>% 
  mutate(snow_depth_day_total_inch_group = case_when(
    is.na(snow_depth_day_total_inch) ~ NA_character_,
    snow_depth_day_total_inch >= 5 ~ "5 inch +",
    snow_depth_day_total_inch >= 4 ~ "4 to <5 inch",
    snow_depth_day_total_inch >= 3 ~ "3 to <4 inch",
    snow_depth_day_total_inch >= 2 ~ "2 to <3 inch",
    snow_depth_day_total_inch >= 1 ~ "1 to <2 inch",
    snow_depth_day_total_inch > 0 ~ ">0 to <1 inch",
    snow_depth_day_total_inch == 0 ~ "0  inch",
    TRUE ~ "Error - please check"
    )
  )

  # reorder based on these new groupings
  noaa_weather <- noaa_weather %>% 
    mutate(snow_depth_day_total_inch = factor
           (snow_depth_day_total_inch, levels =
               c("0  inch",
                 ">0 to <1 inch",
                 "1 to <2 inch", 
                 "2 to <3 inch",
                 "3 to <4 inch",
                 "4 to <5 inch",
                 "5 inch +"))) 

# rename avg temp column
noaa_weather <- noaa_weather %>% 
  rename("temp_avg_day_f" = "tavg")

# add avg temp Fahrenheit groups
# these groups match the Celsius groups below
noaa_weather <- noaa_weather %>% 
  mutate(temp_avg_day_f_group = case_when(
    is.na(temp_avg_day_f) ~ NA_character_,
    temp_avg_day_f >= 104 ~ "104F+",
    temp_avg_day_f >= 86 ~ "86F to <104F",
    temp_avg_day_f >= 68 ~ "68F to <86F",
    temp_avg_day_f >= 50 ~ "50F to <68F",
    temp_avg_day_f >= 32 ~ "32F to <50F",
    temp_avg_day_f >= 14 ~ "14F to <32F",
    temp_avg_day_f >= -4 ~ "-4F to < 14F",
    TRUE ~ "< -4F"
  )
  )

# reorder based on these new groupings
noaa_weather <- noaa_weather %>% 
  mutate(temp_avg_day_f_group = factor
         (temp_avg_day_f_group, levels =
                       c("< -4F",
                       "-4F to < 14F",
                       "14F to <32F", 
                       "32F to <50F",
                       "50F to <68F",
                       "68F to <86F",
                       "86F to <104F",
                       "104F+"
                       )
           )
  )

# add avg temp Celsius column
noaa_weather <- noaa_weather %>% 
  mutate(temp_avg_day_c = (as.numeric(temp_avg_day_f) - 32)*(5/9))

# add avg temp celsius groups
noaa_weather <- noaa_weather %>% 
  mutate(temp_avg_day_c_group = case_when(
    is.na(temp_avg_day_c) ~ NA_character_,
    temp_avg_day_c >= 40 ~ "40c+",
    temp_avg_day_c >= 30 ~ "30c to <40c",
    temp_avg_day_c >= 20 ~ "20c to <30c",
    temp_avg_day_c >= 10 ~ "10c to <20c",
    temp_avg_day_c >= 0 ~ "0c to <10c",
    temp_avg_day_c >= -10 ~ "-10c to <0c",
    temp_avg_day_c >= -20 ~ "-20c to < -10c",
    TRUE ~ "< -20c"
  )
  )



# rename max temp column
noaa_weather <- noaa_weather %>% 
  rename("temp_max_day_f" = "tmax")

# add max temp Fahrenheit groups
# these groups match the Celsius groups below
noaa_weather <- noaa_weather %>% 
  mutate(temp_max_day_f_group = case_when(
    is.na(temp_max_day_f) ~ NA_character_,
    temp_max_day_f >= 104 ~ "104F+",
    temp_max_day_f >= 86 ~ "86F to <104F",
    temp_max_day_f >= 68 ~ "68F to <86F",
    temp_max_day_f >= 50 ~ "50F to <68F",
    temp_max_day_f >= 32 ~ "32F to <50F",
    temp_max_day_f >= 14 ~ "14F to <32F",
    temp_max_day_f >= -4 ~ "-4F to < 14F",
    TRUE ~ "< -4F"
  )
  )

# reorder based on these new groupings
noaa_weather <- noaa_weather %>% 
  mutate(temp_max_day_f_group = factor
         (temp_max_day_f_group, levels =
             c("< -4F",
               "-4F to < 14F",
               "14F to <32F", 
               "32F to <50F",
               "50F to <68F",
               "68F to <86F",
               "86F to <104F",
               "104F+"
             )
         )
  )

# add max temp Celsius column
noaa_weather <- noaa_weather %>% 
  mutate(temp_max_day_c = (as.numeric(temp_max_day_f) - 32)*(5/9))

# add max temp celsius groups
noaa_weather <- noaa_weather %>% 
  mutate(temp_max_day_c_group = case_when(
    is.na(temp_max_day_c) ~ NA_character_,
    temp_max_day_c >= 40 ~ "40c+",
    temp_max_day_c >= 30 ~ "30c to <40c",
    temp_max_day_c >= 20 ~ "20c to <30c",
    temp_max_day_c >= 10 ~ "10c to <20c",
    temp_max_day_c >= 0 ~ "0c to <10c",
    temp_max_day_c >= -10 ~ "-10c to <0c",
    temp_max_day_c >= -20 ~ "-20c to < -10c",
    TRUE ~ "< -20c"
  )
  )



# rename min temp column
noaa_weather <- noaa_weather %>% 
  rename("temp_min_day_f" = "tmin")

# add min temp Fahrenheit groups
# these groups match the Celsius groups below
noaa_weather <- noaa_weather %>% 
  mutate(temp_min_day_f_group = case_when(
    is.na(temp_min_day_f) ~ NA_character_,
    temp_min_day_f >= 104 ~ "104F+",
    temp_min_day_f >= 86 ~ "86F to <104F",
    temp_min_day_f >= 68 ~ "68F to <86F",
    temp_min_day_f >= 50 ~ "50F to <68F",
    temp_min_day_f >= 32 ~ "32F to <50F",
    temp_min_day_f >= 14 ~ "14F to <32F",
    temp_min_day_f >= -4 ~ "-4F to < 14F",
    TRUE ~ "< -4F"
  )
  )

# reorder based on these new groupings
noaa_weather <- noaa_weather %>% 
  mutate(temp_min_day_f_group = factor
         (temp_min_day_f_group, levels =
             c("< -4F",
               "-4F to < 14F",
               "14F to <32F", 
               "32F to <50F",
               "50F to <68F",
               "68F to <86F",
               "86F to <104F",
               "104F+"
             )
         )
  )

# add min temp Celsius column
noaa_weather <- noaa_weather %>% 
  mutate(temp_min_day_c = (as.numeric(temp_min_day_f) - 32)*(5/9))

# add min temp celsius groups
noaa_weather <- noaa_weather %>% 
  mutate(temp_min_day_c_group = case_when(
    is.na(temp_min_day_c) ~ NA_character_,
    temp_min_day_c >= 40 ~ "40c+",
    temp_min_day_c >= 30 ~ "30c to <40c",
    temp_min_day_c >= 20 ~ "20c to <30c",
    temp_min_day_c >= 10 ~ "10c to <20c",
    temp_min_day_c >= 0 ~ "0c to <10c",
    temp_min_day_c >= -10 ~ "-10c to <0c",
    temp_min_day_c >= -20 ~ "-20c to < -10c",
    TRUE ~ "< -20c"
  )
  )

##################################################################
##################################################################

# Join data and create all_data_clean table

all_data_clean <- flights %>% 
  left_join(weather, by = c("origin" = "origin",
                            "time_hour" = "time_hour")) %>% 
  rename("date_ymd" = "date_ymd.x") %>% 
  left_join(noaa_weather, by = c("date_ymd" = "date",
                                 "origin" = "origin")) %>% 
  left_join(planes, by = "tailnum") %>% 
  mutate(plane_type = if_else(is.na(type), "Unknown", type)) %>% 
  mutate(plane_model = if_else(is.na(model), "Unknown", model)) %>% 
  left_join(airports, by = c("dest" = "faa")) %>%
  rename("dest_name" = "name.y") %>% 
  rename("dest_lat" = "lat") %>% 
  rename("dest_long" = "lon") %>% 
  ###################DROP VISIBILITY RECORDS#######################
  # drop records where  visibility is null
  filter(!is.na(visib)) %>% 
  #################################################################
  select(
         # from FLIGHTS
         origin,
         flight_delayed,
         dep_delay,
         delay_group,
         sched_dep_month,
         sched_dep_weekday,
         sched_dep_hour,
         sched_dep_hour_group,
         number_departures_in_sched_dep_hour,
         dest,
         dest_name,
         distance,
         carrier,
         tailnum,
         # from PLANES
         manufacturer,
         plane_type,
         plane_model,
         engine,
         engines,
         seats,
         speed,
         # from WEATHER, NOAA_WEATHER
         visib,
         visib_group,
         wind_speed_mph,
         wind_speed_beaufort_name,
         wind_gust_mph,
         wind_gust_beaufort_name,
         wind_dir,
         wind_dir_cardinal,
         precip_day_total_inch,
         precip_day_total_cm,
         precip_day_total_inch_group,
         snowfall_day_total_inch,
         snowfall_day_total_inch_group,
         snow_depth_day_total_inch,
         snow_depth_day_total_inch_group,
         temp_avg_day_c,
         temp_avg_day_c_group,
         temp_avg_day_f,
         temp_avg_day_f_group,
         temp_max_day_c,
         temp_max_day_c_group,
         temp_max_day_f,
         temp_max_day_f_group,
         temp_min_day_c,
         temp_min_day_c_group,
         temp_min_day_f,
         temp_min_day_f_group,
         # from AIRPORTS
         dest_lat,
         dest_long
  ) 


# Write all_data_clean to a csv in the data_clean folder

write_csv(all_data_clean, here("data_clean/all_data_clean.csv"))
```




**Flights:**

This is the table of departure information supplied with the brief.

* NA flight delay time - dropped 7,814 records where this was missing (of 303,748 total records)

**Weather:**

This is also one of the tables supplied with the brief, and contains hourly weather observations for the three airports.

* NA wind speed: replaced with avg daily wind speed from NOAA (2,647 records)

* NA wind direction: replaced with a calculated daily median (2,661)

* NA temperature : 25,642 of 26,201 records had NA for temperature - using NOAA max daily temperature instead

* Precipitation: similar amount of NAs as there were for temperature, daily total from NOAA used instead

* NA visibility - dropped records where this was missing (11 records)

**Planes:**

This file, supplied with the brief, has information on various features of individual aircraft.

602 planes which are in the `flights` table, accounting for around 36,000 flights (more than 10% of total), are not present in the `planes` tables.

I tried downloading plane registration data from the Federal Aviation Administration (FAA) website, but returned an almost identical result (611 planes missing).
https://www.faa.gov/licenses_certificates/aircraft_certification/aircraft_registry/releasable_aircraft_download/

Plane type and model were set to "unknown" where the plane could not be identified.
